@page "/"
@page "/index"

@using MediatR;
@using Template.WebUI.Components;
@using Template.Application.Features.Note.Queries;
@using Template.Application.Interfaces.Services;
@using Template.Application.Features.Note.Shared.Dto;

@inject INoteService noteService
@inject NavigationManager navManager
@inject IMediator Mediator

<PageTitle>Home</PageTitle>

<AuthorizeView>

    <Authorized>

        @* MOBILE *@
        <div class="h-full lg:hidden">

            @if (_selectedNote == null)
            {
                <div class="addBtnContainer lg:hidden">

                    <div class="addNoteBtn">
                        <img src="/img/appBtn.svg" />
                    </div>

                </div>
            }

            <div class="flex flex-col h-full w-full px-4 py-4 gap-3 text-zinc-600">

                @if (_selectedNote == null)
                {
                    @foreach (var note in _notesList)
                    {
                        <NoteCard Note="@note" IsNoteSelected="IsNoteSelected" />
                    }
                }
                else
                {
                    <UpdateNoteForm Note="@_selectedNote" IsNoteUpdated="IsNoteUpdated" IsNoteDeleted="IsNoteDeleted" />
                }


            </div>

        </div>

        @* DESKTOP *@
        <div class="hidden lg:flex h-full">

            <div class="flex flex-row h-full w-full">

                <div class="flex flex-col h-full w-2/4 px-4 py-4 gap-3 text-zinc-600">

                    @foreach (var note in _notesList)
                    {
                        <NoteCard Note="@note" IsNoteSelected="IsNoteSelected" />
                    }

                </div>

                <div class="w-2/4 m-4 border border-1 rounded-xl bg-yellow-100">

                    @if (_selectedNote == null)
                    {
                        <CreateNoteForm IsNoteCreated="IsNoteCreated" />
                    }
                    else
                    {
                        <UpdateNoteForm Note="@_selectedNote" IsNoteUpdated="IsNoteUpdated" IsNoteDeleted="IsNoteDeleted" />
                    }

                </div>

            </div>

        </div>

    </Authorized>

    <NotAuthorized>
        <div class="flex flex-col h-full w-full px-8 py-4 gap-3 text-zinc-600 lg:px-4">

            <h1 class="text-3xl">Welcome</h1>
            <p class="text-xl">To enjoy the Quill features, please Sign in or create an account.</p>

        </div>
    </NotAuthorized>

</AuthorizeView>

@code {

    private List<NoteDto> _notesList = new();

    private NoteDto _selectedNote = null;

    protected override async Task OnInitializedAsync()
    {
        _notesList = await Mediator.Send(new GetAllNotesQuery());
    }

    #region Mobile
    private void IsNoteSelectedMobile(NoteDto selectedNoteDto)
    {
        navManager.NavigateTo($"/updateNoteMobile/{selectedNoteDto.Id}");
    }
    #endregion

    #region Desktop
    private void IsNoteSelected(NoteDto selectedNoteDto)
    {
        _selectedNote = selectedNoteDto;
    }

    private void IsNoteCreated(NoteDto newNoteDto)
    {
        if (newNoteDto != null)
        {
            _notesList.Add(newNoteDto);
        }
    }

    private void IsNoteUpdated(bool result)
    {
        if (result)
        {
            _selectedNote = null;
            navManager.NavigateTo("/");
        }
    }

    private void IsNoteDeleted(NoteDto noteDeleted)
    {
        if (noteDeleted != null)
        {
            _notesList.Remove(noteDeleted);
        }
    }
    #endregion
}